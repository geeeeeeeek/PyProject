{% extends 'base/base.html' %}
{% load static %}
{% load video_tag %}
{% block css %}
<link href="http://imgcache.qq.com/open/qcloud/video/tcplayer/tcplayer.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/dropload.css' %}">
{% endblock css %}

{% block content %}
<div class="ui unstackable two column grid">
    <div class=" ten wide column">
        <video class="video" autoplay="autoplay" muted="" controls="controls">
            <source src="http://www.runoob.com/try/demo_source/mov_bbb.mp4" type="video/mp4">
        </video>
        <div class="video-info">
            <div class="video-title">{{ video.title }}</div>
            <div class="video-view-count">{{ video.view_count }}次观看</div>
            <div class="extra content video-view-operation">
                    <span class="left floated like">
                        <i class="like {%  user_liked_class video user %} icon cursor" id="like" video-id="{{ video.id }}"></i>
                        <span id="like-count">{{ video.count_likers }}</span>
                    </span>
                    <span class="right floated star">
                        <i class="star {%  user_collected_class video user %}  icon cursor" id="star" video-id="{{ video.id }}"></i>
                        <span id="collect-count">{{ video.count_collecters }}</span>
                    </span>
            </div>

            <div class="ui divider"></div>
        </div>

        <div class="ui comments">

            {% if user.is_authenticated %}
            <form class="ui reply form" id="comment_form" method="post"
                  action="{% url 'comment:submit_comment' video.pk %}">
                {% csrf_token %}
                <div class="field">
                    {{form.content}}
                    <input type="hidden" value="{{ video.id }}" name="video_id">
                </div>
                <button class="ui primary button" type="submit">
                    添加评论
                </button>
                <div class="ui info message n">
                    <div class="item" id="comment-result"></div>
                </div>
            </form>
            {% else %}
            <div class="ui ignored info attached message">
                <p>登录后即可评论 &nbsp;&nbsp;&nbsp;<a href="{% url 'users:login' %}?next={{ request.path }}">马上登录</a></p>
            </div>
            {% endif %}

            <h3 class="ui dividing header" id="id_comment_label">评论</h3>
            <div class="comment-list">
            </div>
        </div>


    </div>
    <div class="six wide column">
        {% include "video/recommend.html" %}
    </div>
</div>
{% endblock content %}

{% block javascript %}
<script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="{% static 'js/dropload.min.js' %}"></script>
<script src="{% static 'js/detail.js' %}?v=12"></script>
<script type="text/javascript">


// todo 引入 https://github.com/mescroll/mescroll
// todo 引入 https://github.com/mescroll/mescroll

$(function(){
    // 页数
    var page = 0;
    // 每页展示10个
    var size = 10;

    // dropload
    $('.comments').dropload({
        scrollArea : window,
        loadDownFn : function(me){
            page++;

            var html = '';
            $.ajax({
                type: 'GET',
                url: 'http://127.0.0.1:8000/video/get_comments',
                data:{
                     video_id:{{ video.id }},
                     page: page
                },
                dataType: 'json',
                success: function(data){
                    var code = data.code
                    var count = data.comment_count
                    if(code == 0){
                        html = data.html
                        $('#id_comment_label').text(count + "条评论");

                    // 如果没有数据
                    }else{
                        // 锁定
                        me.lock();
                        // 无数据
                        me.noData();
                    }
                    // 为了测试，延迟1秒加载
                    setTimeout(function(){
                        // 插入数据到页面，放到最后面
                        $('.comment-list').append(html);
                        // 每次数据插入，必须重置
                        me.resetload();
                    },1000);
                },
                error: function(xhr, type){
                    // alert('Ajax error!');
                    // 即使加载出错，也得重置
                    me.resetload();
                }
            });
        }
    });
});


</script>

<script type="text/javascript">
    var frm = $('#comment_form');
    frm.submit(function () {
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            dataType:'json',
            data: frm.serialize(),
            success: function (data) {
                var code = data.code
                var msg = data.msg
                if(code == 0){
                    $('#id_content').val("")
                    $('.comment-list').prepend(data.html);
                    $('#comment-result').text("评论成功")
                    $('.info').show().delay(2000).fadeOut(800)
                }else{
                    $('#comment-result').text(msg)
                    $('.info').show().delay(2000).fadeOut(800);
                }
            },
            error: function(data) {
            }
        });
        return false;
    });

</script>

<script>

</script>


{% endblock javascript %}
 
